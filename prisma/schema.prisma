generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


model User {
  id               Int               @id @default(autoincrement())
  username         String            @unique
  passwordHash     String            @map("password_hash")
  fullName         String            @map("full_name")
  role             Role              @default(CASHIER)
  pinCode          String?           @map("pin_code")
  createdAt        DateTime          @default(now()) @map("created_at")
  shiftReports     ShiftReport[]
  stockAdjustments StockAdjustment[]

  @@map("users")
}

model Member {
  id              Int                 @id @default(autoincrement())
  memberCode      String              @unique @map("member_code")
  fullName        String              @map("full_name")
  phone           String
  tier            Tier                @default(BRONZE)
  pointsBalance   Int                 @default(0) @map("points_balance")
  walletBalance   Decimal             @default(0) @map("wallet_balance")
  joinDate        DateTime            @default(now()) @map("join_date") @db.Date
  status          MemberStatus        @default(ACTIVE)
  lastVisitAt     DateTime?           @map("last_visit_at")
  transactions    PointTransaction[]
  walletHistory   WalletTransaction[]
  sessions        TableSession[]
  orders          Order[]

  @@map("members")
}

model PointTransaction {
  id          Int       @id @default(autoincrement())
  memberId    Int       @map("member_id")
  member      Member    @relation(fields: [memberId], references: [id])
  type        PointType @map("type")
  amount      Int
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("point_transactions")
}

model WalletTransaction {
  id          Int                   @id @default(autoincrement())
  memberId    Int                   @map("member_id")
  member      Member                @relation(fields: [memberId], references: [id])
  type        WalletTransactionType
  amount      Decimal
  description String?
  paymentMethod PaymentMethod?      @map("payment_method") // For TOPUP
  createdAt   DateTime              @default(now()) @map("created_at")
  
  @@map("wallet_transactions")
}

model Table {
  id          String         @id
  name        String
  type        TableType
  hourlyRate  Decimal        @map("hourly_rate")
  status      TableStatus    @default(AVAILABLE)
  sessions    TableSession[]
  reservations Reservation[]

  @@map("tables")
}

model TableSession {
  id              Int           @id @default(autoincrement())
  tableId         String        @map("table_id")
  table           Table         @relation(fields: [tableId], references: [id])
  customerName    String?       @map("customer_name")
  memberId        Int?          @map("member_id")
  member          Member?       @relation(fields: [memberId], references: [id])
  startTime       DateTime      @default(now()) @map("start_time")
  endTime         DateTime?     @map("end_time")
  durationMinutes Int?          @map("duration_minutes")
  totalCost       Decimal?      @map("total_cost")
  status          SessionStatus @default(OPEN)
  pax             Int           @default(1)
  orders          Order[]

  @@map("table_sessions")
}

model Product {
  id               String            @id
  name             String
  category         ProductCategory
  price            Decimal
  stockQty         Int               @map("stock_qty")
  imageUrl         String?           @map("image_url")
  isActive         Boolean           @default(true) @map("is_active")
  orderItems       OrderItem[]
  stockAdjustments StockAdjustment[]

  @@map("products")
}

model Order {
  id            Int             @id @default(autoincrement())
  invoiceNo     String          @unique @map("invoice_no")
  sessionId     Int?            @map("session_id")
  session       TableSession?   @relation(fields: [sessionId], references: [id])
  memberId      Int?            @map("member_id")
  customerName  String?         @map("customer_name")
  member        Member?         @relation(fields: [memberId], references: [id])
  subtotal      Decimal
  discountAmount Decimal        @default(0) @map("discount_amount")
  pointsRedeemed Int            @default(0) @map("points_redeemed")
  taxAmount     Decimal         @map("tax_amount")
  totalAmount   Decimal         @map("total_amount")
  paymentMethod PaymentMethod   @map("payment_method")
  paymentStatus PaymentStatus   @default(PENDING) @map("payment_status")
  createdAt     DateTime        @default(now()) @map("created_at")
  items         OrderItem[]

  @@map("orders")
}

model OrderItem {
  id          Int      @id @default(autoincrement())
  orderId     Int      @map("order_id")
  order       Order    @relation(fields: [orderId], references: [id])
  productId   String?  @map("product_id")
  product     Product? @relation(fields: [productId], references: [id])
  itemName    String   @map("item_name")
  quantity    Int
  unitPrice   Decimal  @map("unit_price")
  totalPrice  Decimal  @map("total_price")

  @@map("order_items")
}

model Reservation {
  id              Int               @id @default(autoincrement())
  customerName    String            @map("customer_name")
  phone           String
  bookingDate     DateTime          @map("booking_date") @db.Date
  bookingTime     DateTime          @map("booking_time") @db.Time
  pax             Int
  tableType       TableType         @map("table_type")
  assignedTableId String?           @map("assigned_table_id")
  assignedTable   Table?            @relation(fields: [assignedTableId], references: [id])
  status          ReservationStatus @default(PENDING)
  notes           String?

  @@map("reservations")
}

model ShiftReport {
  id              Int      @id @default(autoincrement())
  staffId         Int      @map("staff_id")
  staff           User     @relation(fields: [staffId], references: [id])
  openedAt        DateTime @map("opened_at")
  closedAt        DateTime? @map("closed_at")
  openingCash     Decimal  @map("opening_cash")
  systemCash      Decimal  @map("system_cash")
  actualCash      Decimal  @map("actual_cash")
  variance        Decimal
  varianceReason  String?  @map("variance_reason")

  @@map("shift_reports")
}

enum Role {
  ADMIN
  CASHIER
  MANAGER
}

enum Tier {
  GOLD
  SILVER
  BRONZE
}

enum MemberStatus {
  ACTIVE
  EXPIRED
  BANNED
}

enum PointType {
  EARN
  REDEEM
}

enum WalletTransactionType {
  TOPUP
  USAGE
  REFUND
  ADJUSTMENT
}

enum TableType {
  VIP
  REGULAR
  SNOOKER
}

enum TableStatus {
  AVAILABLE
  ACTIVE
  BOOKED
  CLEANING
}

enum SessionStatus {
  OPEN
  PAUSED
  CLOSED
}

enum ProductCategory {
  FOOD
  DRINK
  SNACK
}

enum PaymentMethod {
  CASH
  QRIS
  DEBIT
  CREDIT
  DEPOSIT
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELLED
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

// ==================== MANAGER MODE MODELS ====================

model Promo {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  type        PromoType
  value       Decimal
  minPurchase Decimal?  @map("min_purchase")
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  startTime   String?   @map("start_time") // HH:mm format for happy hour
  endTime     String?   @map("end_time")
  daysOfWeek  String?   @map("days_of_week") // comma-separated: 0,1,2,3,4,5,6
  tableTypes  String?   @map("table_types") // comma-separated: VIP,REGULAR,SNOOKER
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("promos")
}

enum PromoType {
  PERCENTAGE
  FIXED_AMOUNT
  HAPPY_HOUR
}

model StockAdjustment {
  id          Int            @id @default(autoincrement())
  productId   String         @map("product_id")
  product     Product        @relation(fields: [productId], references: [id])
  adjustType  AdjustmentType @map("adjust_type")
  quantity    Int
  previousQty Int            @map("previous_qty")
  newQty      Int            @map("new_qty")
  reason      String?
  adjustedBy  Int            @map("adjusted_by")
  adjuster    User           @relation(fields: [adjustedBy], references: [id])
  createdAt   DateTime       @default(now()) @map("created_at")

  @@map("stock_adjustments")
}

enum AdjustmentType {
  IN
  OUT
  CORRECTION
  INITIAL
}

model BusinessConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("business_config")
}

