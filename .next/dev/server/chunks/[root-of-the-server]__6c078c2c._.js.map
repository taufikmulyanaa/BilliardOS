{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/Documents/BilliardOS/app/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\nconst prismaClientSingleton = () => {\r\n    return new PrismaClient();\r\n};\r\n\r\ntype PrismaClientSingleton = ReturnType<typeof prismaClientSingleton>;\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n    prisma: PrismaClientSingleton | undefined;\r\n};\r\n\r\nexport const prisma = globalForPrisma.prisma ?? prismaClientSingleton();\r\n\r\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,wBAAwB;IAC1B,OAAO,IAAI,6IAAY;AAC3B;AAIA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI;AAEhD,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 68, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/Documents/BilliardOS/app/src/app/api/reservations/check/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// GET: Check for upcoming reservations that need notification or auto-cancel\r\nexport async function GET() {\r\n    try {\r\n        const now = new Date();\r\n        const fiveMinutesFromNow = new Date(now.getTime() + 5 * 60 * 1000);\r\n        const fifteenMinutesAgo = new Date(now.getTime() - 15 * 60 * 1000);\r\n\r\n        // Get today's date at midnight\r\n        const today = new Date();\r\n        today.setHours(0, 0, 0, 0);\r\n\r\n        // Find all CONFIRMED reservations for today\r\n        const reservations = await prisma.reservation.findMany({\r\n            where: {\r\n                status: 'CONFIRMED',\r\n                bookingDate: {\r\n                    gte: today,\r\n                    lt: new Date(today.getTime() + 24 * 60 * 60 * 1000)\r\n                }\r\n            }\r\n        });\r\n\r\n        const alerts: any[] = [];\r\n        const toCancel: number[] = [];\r\n\r\n        for (const res of reservations) {\r\n            // Combine bookingDate and bookingTime to get full datetime\r\n            const bookingDateTime = new Date(res.bookingDate);\r\n            const bookingTime = new Date(res.bookingTime);\r\n            bookingDateTime.setHours(bookingTime.getHours(), bookingTime.getMinutes(), 0, 0);\r\n\r\n            const timeDiff = bookingDateTime.getTime() - now.getTime();\r\n            const minutesDiff = timeDiff / (60 * 1000);\r\n\r\n            // Check if within 5 minutes of start time (but not past)\r\n            if (minutesDiff > 0 && minutesDiff <= 5) {\r\n                alerts.push({\r\n                    type: 'upcoming',\r\n                    reservation: res,\r\n                    message: `Booking ${res.customerName} akan dimulai dalam ${Math.ceil(minutesDiff)} menit!`,\r\n                    minutesUntilStart: Math.ceil(minutesDiff)\r\n                });\r\n            }\r\n\r\n            // Check if booking time has passed and needs confirmation\r\n            if (minutesDiff <= 0 && minutesDiff > -15) {\r\n                alerts.push({\r\n                    type: 'waiting_confirmation',\r\n                    reservation: res,\r\n                    message: `Booking ${res.customerName} sudah waktunya! Menunggu konfirmasi kasir.`,\r\n                    minutesPast: Math.abs(Math.floor(minutesDiff))\r\n                });\r\n            }\r\n\r\n            // Check if 15+ minutes past booking time - auto cancel\r\n            if (minutesDiff <= -15) {\r\n                toCancel.push(res.id);\r\n            }\r\n        }\r\n\r\n        // Auto-cancel no-shows\r\n        if (toCancel.length > 0) {\r\n            await prisma.reservation.updateMany({\r\n                where: { id: { in: toCancel } },\r\n                data: { status: 'CANCELLED' }\r\n            });\r\n\r\n            // Add cancel notifications\r\n            for (const id of toCancel) {\r\n                const res = reservations.find(r => r.id === id);\r\n                if (res) {\r\n                    alerts.push({\r\n                        type: 'auto_cancelled',\r\n                        reservationId: id,\r\n                        message: `Booking ${res.customerName} otomatis dibatalkan (no-show).`\r\n                    });\r\n                }\r\n            }\r\n        }\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            alerts,\r\n            cancelledCount: toCancel.length\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Check Reservations Error:\", error);\r\n        return NextResponse.json({ error: \"Internal Error\" }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEO,MAAM,UAAU;AAGhB,eAAe;IAClB,IAAI;QACA,MAAM,MAAM,IAAI;QAChB,MAAM,qBAAqB,IAAI,KAAK,IAAI,OAAO,KAAK,IAAI,KAAK;QAC7D,MAAM,oBAAoB,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,KAAK;QAE7D,+BAA+B;QAC/B,MAAM,QAAQ,IAAI;QAClB,MAAM,QAAQ,CAAC,GAAG,GAAG,GAAG;QAExB,4CAA4C;QAC5C,MAAM,eAAe,MAAM,gIAAM,CAAC,WAAW,CAAC,QAAQ,CAAC;YACnD,OAAO;gBACH,QAAQ;gBACR,aAAa;oBACT,KAAK;oBACL,IAAI,IAAI,KAAK,MAAM,OAAO,KAAK,KAAK,KAAK,KAAK;gBAClD;YACJ;QACJ;QAEA,MAAM,SAAgB,EAAE;QACxB,MAAM,WAAqB,EAAE;QAE7B,KAAK,MAAM,OAAO,aAAc;YAC5B,2DAA2D;YAC3D,MAAM,kBAAkB,IAAI,KAAK,IAAI,WAAW;YAChD,MAAM,cAAc,IAAI,KAAK,IAAI,WAAW;YAC5C,gBAAgB,QAAQ,CAAC,YAAY,QAAQ,IAAI,YAAY,UAAU,IAAI,GAAG;YAE9E,MAAM,WAAW,gBAAgB,OAAO,KAAK,IAAI,OAAO;YACxD,MAAM,cAAc,WAAW,CAAC,KAAK,IAAI;YAEzC,yDAAyD;YACzD,IAAI,cAAc,KAAK,eAAe,GAAG;gBACrC,OAAO,IAAI,CAAC;oBACR,MAAM;oBACN,aAAa;oBACb,SAAS,CAAC,QAAQ,EAAE,IAAI,YAAY,CAAC,oBAAoB,EAAE,KAAK,IAAI,CAAC,aAAa,OAAO,CAAC;oBAC1F,mBAAmB,KAAK,IAAI,CAAC;gBACjC;YACJ;YAEA,0DAA0D;YAC1D,IAAI,eAAe,KAAK,cAAc,CAAC,IAAI;gBACvC,OAAO,IAAI,CAAC;oBACR,MAAM;oBACN,aAAa;oBACb,SAAS,CAAC,QAAQ,EAAE,IAAI,YAAY,CAAC,2CAA2C,CAAC;oBACjF,aAAa,KAAK,GAAG,CAAC,KAAK,KAAK,CAAC;gBACrC;YACJ;YAEA,uDAAuD;YACvD,IAAI,eAAe,CAAC,IAAI;gBACpB,SAAS,IAAI,CAAC,IAAI,EAAE;YACxB;QACJ;QAEA,uBAAuB;QACvB,IAAI,SAAS,MAAM,GAAG,GAAG;YACrB,MAAM,gIAAM,CAAC,WAAW,CAAC,UAAU,CAAC;gBAChC,OAAO;oBAAE,IAAI;wBAAE,IAAI;oBAAS;gBAAE;gBAC9B,MAAM;oBAAE,QAAQ;gBAAY;YAChC;YAEA,2BAA2B;YAC3B,KAAK,MAAM,MAAM,SAAU;gBACvB,MAAM,MAAM,aAAa,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;gBAC5C,IAAI,KAAK;oBACL,OAAO,IAAI,CAAC;wBACR,MAAM;wBACN,eAAe;wBACf,SAAS,CAAC,QAAQ,EAAE,IAAI,YAAY,CAAC,+BAA+B,CAAC;oBACzE;gBACJ;YACJ;QACJ;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT;YACA,gBAAgB,SAAS,MAAM;QACnC;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;IACxE;AACJ"}}]
}